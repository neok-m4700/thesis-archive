C     ***ABHIJIT MUKHERJEE 
C     ***BUBBLE***
C     ****************************
	SUBROUTINE VVELOCITY3D
C	****************************
	IMPLICIT NONE
 	INCLUDE "VAR3D.DEC"
C	*******************************
!
!	*** VEL VARIABLES ***
	REAL(8) UU(ID,JD,KD), VV(ID,JD,KD)
	REAL(8) WW(ID,JD,KD)
	COMMON  /VEL/UU, VV, WW
!
!	*** LEVEL SET ***
	REAL(8) LS(-1:ID+2,-1:JD+2,-1:KD+2), H(ID,JD,KD)
	COMMON /LSET/LS, H
!
C	*** COEFFICIENTS IN DISCRETIZATION EQUATION ***
	REAL(8) AE(ID,JD,KD),AW(ID,JD,KD),AN(ID,JD,KD)
	REAL(8) AS(ID,JD,KD),AT(ID,JD,KD),AB(ID,JD,KD)
	REAL(8) AP(ID,JD,KD),BB(ID,JD,KD),PHI(-1:ID+2,-1:JD+2,-1:KD+2)
	REAL(8) RP0, RPK, RPR,GAMMAP 
	CHARACTER VAR
	COMMON /TDMA/AE,AW,AN,AS,AT,AB,AP,BB,PHI
	6 ,RP0,RPK,RPR,GAMMAP,VAR
!
C	**** PROPERTIES **************************
	REAL(8) RHO(ID,JD,KD),RHOOLD(ID,JD,KD),MU(ID,JD,KD)
	REAL(8) COND(ID,JD,KD), CP(ID,JD,KD)
	REAL(8) BETA
	COMMON /PROP/RHO, RHOOLD, MU, COND, CP, BETA
C
C	*** VEL FIELD FOR SIMPLE(DOES NOT SATISFY CONTINUITY) ***
	REAL(8) USTAR(-1:ID+2,-1:JD+2,-1:KD+2)
	REAL(8) VSTAR(-1:ID+2,-1:JD+2,-1:KD+2)
	REAL(8) WSTAR(-1:ID+2,-1:JD+2,-1:KD+2)
	COMMON /STAR/USTAR,VSTAR,WSTAR
!
C	*** VELOCITY STAGGERED ***
	REAL(8) USTGR(ID,JD,KD),VSTGR(ID,JD,KD),WSTGR(ID,JD,KD)
	COMMON /STGR/USTGR, VSTGR, WSTGR
!
C	*** THAT HAVE TO BE KNOWN IN THE PRESSURE EQUATION ***
	REAL(8) APU(ID,JD,KD), APV(ID,JD,KD),APW(ID,JD,KD)
	COMMON /APS/APU, APV, APW
!
C	*** TEMPORARY ARRAY FOR THE NEW UVEL, BECAUSE IN VVEL ***
C	*** THE OLD VALUES HAVE TO BE USED ***
	REAL(8) UNEW(ID,JD,KD),VNEW(ID,JD,KD)
	COMMON /UVNEW/UNEW, VNEW
!
C	*** CURVATURE ***
	REAL(8) KK(ID,JD,KD)
	COMMON /KK/KK
!
C	*** PRESSURE-FIELD FROM THE PRESSURE EQUATION ***
	REAL(8) PP(ID,JD,KD), PCORR(ID,JD,KD)
	COMMON /PRES/ PP, PCORR
!
C	*** TEMPERATURE FIELD FROM THE OLD TIMESTEP ***
	REAL(8) TOLD(ID,JD,KD), T(ID,JD,KD)
	COMMON /TT/TOLD, T
!
C	***LOCAL VARIABLES MU SOURCE ***
	REAL(8) MS1, MS2, MS3	!, ALPHAV
	REAL(8) APO
	INTEGER I,J,K
!
C	*** PATANKAR FUNCTIONS ***
	REAL(8) DDI, DDJ,DDK
	REAL(8) FFI, FFJ,FFK
	REAL(8) PEI, PEJ, PEK
	REAL(8) APEI,APEJ,APEK
!
!	*** INTERFACE PROPERTIES ***
	REAL(8) RHOINTI,RHOINTJ,RHOINTK,RHOINTJOLD
	REAL(8) RHOINTI1,RHOINTJ1,RHOINTK1
	REAL(8) MUINTI, MUINTJ, MUINTK 
	REAL(8) MUINTI1, MUINTJ1, MUINTK1
	REAL(8) MUINTI2, MUINTJ2, MUINTK2 
	REAL(8) MUINTI3, MUINTJ3, MUINTK3
!
C	*** INITIALIZE ***
!	ALPHAV=OMEGAVEL
	MS1=0.
	MS2=0.
	MS3=0.
	RHOINTI=0.
	RHOINTI1=0.
	RHOINTJ=0.
	RHOINTK=0.
	RHOINTK1=0.
	MUINTI=0.
	MUINTI1=0.
	MUINTI2=0.
	MUINTI3=0.
	MUINTK=0.
	MUINTK1=0.
	MUINTK2=0.
	MUINTK3=0.
	RHOINTJOLD=0.
	FFI=0.
	FFJ=0.
	FFK=0.
	DDI=0.
	DDJ=0.
	DDK=0.
	PEI=0.
	PEJ=0.
	PEK=0.
	APEI=0.
	APEJ=0.
	APEK=0.
C	
	DO 100 K=1, N2
	DO 100 J=1, M1
	DO 100 I=1, L2
	AN(I,J,K)=0.0
	AS(I,J,K)=0.0
	AE(I,J,K)=0.0
	AW(I,J,K)=0.0
	AT(I,J,K)=0.0
	AB(I,J,K)=0.0
	AP(I,J,K)=1.0
	BB(I,J,K)=0.0
	APV(I,J,K)=0.0
100	CONTINUE
!
C	*** INTERIOR A'S AND B'S ***
	DO 300 K=2, N1
	DO 300 J=2, M
	DO 300 I=2, L1
C
	RHOINTI=(RHO(I-1,J,K)+RHO(I,J,K))/2.
	RHOINTI1=(RHO(I-1,J+1,K)+RHO(I,J+1,K))/2.
	MUINTI=2.*MU(I-1,J,K)*MU(I,J,K)/
     6 	(MU(I-1,J,K)+MU(I,J,K))
	MUINTI1=2.*MU(I-1,J+1,K)*MU(I,J+1,K)/
     6 	(MU(I-1,J+1,K)+MU(I,J+1,K))
	FFI=(RHOINTI*USTAR(I-1,J,K)*DY*DZ+
     6 	RHOINTI1*USTAR(I-1,J+1,K)*DY*DZ)/2.
	DDI=((MUINTI+MUINTI1)/2.)*DY*DZ/DX/REL
	PEI=FFI/DDI
	APEI=AMAX1(0., (1. - 0.1*(ABS(PEI)) )**5 )
	AW(I,J,K)=DDI*APEI+AMAX1(FFI,0.)
C
	RHOINTI=(RHO(I,J,K)+RHO(I+1,J,K))/2.
	RHOINTI1=(RHO(I,J+1,K)+RHO(I+1,J+1,K))/2.
	MUINTI2=2*MU(I,J,K)*MU(I+1,J,K)/
     6 	(MU(I,J,K)+MU(I+1,J,K))
	MUINTI3=2*MU(I,J+1,K)*MU(I+1,J+1,K)/
     6 	(MU(I,J+1,K)+MU(I+1,J+1,K))
	FFI=(RHOINTI*USTAR(I,J,K)*DY*DZ+
     6 	RHOINTI1*USTAR(I,J+1,K)*DY*DZ)/2.
	DDI=((MUINTI2+MUINTI3)/2.)*DY*DZ/DX/REL
	PEI=FFI/DDI
	APEI=AMAX1(0., (1. - 0.1*(ABS(PEI)) )**5 )
	AE(I,J,K)=DDI*APEI+AMAX1(-FFI,0.)
C	**********************************************************
	FFJ=RHO(I,J,K)*VV(I,J,K)*DZ*DX
	DDJ=MU(I,J,K)*DZ*DX/DY/REL
	PEJ=FFJ/DDJ
	APEJ=AMAX1(0., (1. - 0.1*(ABS(PEJ)) )**5 )
	AS(I,J,K)=DDJ*APEJ+AMAX1(FFJ,0.)
C
	FFJ=RHO(I,J+1,K)*VV(I,J+1,K)*DZ*DX
	DDJ=MU(I,J+1,K)*DZ*DX/DY/REL
	PEJ=FFJ/DDJ
	APEJ=AMAX1(0., (1. - 0.1*(ABS(PEJ)) )**5 )
	AN(I,J,K)=DDJ*APEJ+AMAX1(-FFJ,0.)
C	***********************************************************
	RHOINTK=(RHO(I,J,K-1)+RHO(I,J,K))/2.
	RHOINTK1=(RHO(I,J+1,K-1)+RHO(I,J+1,K))/2.
	MUINTK=2*MU(I,J,K-1)*MU(I,J,K)/
     6  	(MU(I,J,K-1)+MU(I,J,K))
	MUINTK1=2*MU(I,J+1,K-1)*MU(I,J+1,K)/
     6  	(MU(I,J+1,K-1)+MU(I,J+1,K))
	FFK=(RHOINTK*WSTAR(I,J,K-1)*DX*DY+
     6 	RHOINTK1*WSTAR(I,J+1,K-1)*DX*DY)/2.
	DDK=((MUINTK+MUINTK1)/2.)*DX*DY/DZ/REL
	PEK=FFK/DDK
	APEK=AMAX1(0., (1. - 0.1*(ABS(PEK)) )**5 )
	AB(I,J,K)=DDK*APEK+AMAX1(FFK,0.)
C
	RHOINTK=(RHO(I,J,K)+RHO(I,J,K+1))/2.
	RHOINTK1=(RHO(I,J+1,K)+RHO(I,J+1,K+1))/2.
	MUINTK2=2*MU(I,J,K)*MU(I,J,K+1)/
     6  	(MU(I,J,K)+MU(I,J,K+1))
	MUINTK3=2*MU(I,J+1,K)*MU(I,J+1,K+1)/
     6  	(MU(I,J+1,K)+MU(I,J+1,K+1))
	FFK=(RHOINTK*WSTAR(I,J,K)*DX*DY+
     6 	RHOINTK1*WSTAR(I,J+1,K)*DX*DY)/2.
	DDK=((MUINTK2+MUINTK3)/2.)*DX*DY/DZ/REL
	PEK=FFK/DDK
	APEK=AMAX1(0., (1. - 0.1*(ABS(PEK)) )**5 )
	AT(I,J,K)=DDK*APEK+AMAX1(-FFK,0.)
C	***************************************************
	RHOINTJOLD=(RHOOLD(I,J,K)+RHOOLD(I,J+1,K))/2.
	APO=RHOINTJOLD*DX*DY*DZ/DT
!
C	***REMEMBER RHOINTJ IS FROM PREVIOUS TIMESTEP***
	AP(I,J,K)=AW(I,J,K)+AE(I,J,K)+AS(I,J,K)+AN(I,J,K)
     6 +AB(I,J,K)+AT(I,J,K)+APO
!
	MS1=(((MUINTI3+MUINTI2)/2.)
     6	*(USTAR(I,J+1,K)-USTAR(I,J,K))/DY
     6	-((MUINTI1+MUINTI)/2.)
     6	*(USTAR(I-1,J+1,K)-USTAR(I-1,J,K))/DY)*DY*DZ/REL
	MS2=(MU(I,J+1,K)*(VSTAR(I,J+1,K)-VSTAR(I,J,K))/DY
     6	-MU(I,J,K)*(VSTAR(I,J,K)-VSTAR(I,J-1,K))/DY)*DX*DZ/REL
	MS3=(((MUINTK3+MUINTK2)/2.)
     6	*(WSTAR(I,J+1,K)-WSTAR(I,J,K))/DY
     6	-((MUINTK1+MUINTK)/2.)
     6	*(WSTAR(I,J+1,K-1)-WSTAR(I,J,K-1))/DY)*DX*DY/REL
	RHOINTJ=(RHO(I,J,K)+RHO(I,J+1,K))/2.
	BB(I,J,K)=APO*VSTGR(I,J,K)
!
!     6	+ BETA*(RHOINTJ)
!     6 	*((T(I,J+1,K)+T(I,J,K))/2.)*(TWALL-TINF)
!     6   	*DX*DY*DZ*0.0						! SCALING FOR GRAVITY
!
     6  	+(PP(I,J,K)-PP(I,J+1,K))*DX*DZ
!
     6  	-(1./EOL)*(H(I,J,K)-H(I,J+1,K))*((KK(I,J,K)+KK(I,J+1,K))/2./DY)
     6  	*DX*DY*DZ
!
!     6  	-(RHOINTJ)*DX*DY*DZ*0.0				! SCALING FOR GRAVITY
!
     6  	+MS1+MS2+MS3
!
300	CONTINUE
!
C	*** BOUNDARY A'S AND B'S ***	
!
C	*** WEST BOUNDARY IS INLET ***
C	*** U=Uin, V=W=T=0
	I=1
	DO 400 J=2,M
	DO 400 K=2,N1
	AE(I,J,K)=0.
	AW(I,J,K)=0.
	AN(I,J,K)=0.
	AS(I,J,K)=0.
	AT(I,J,K)=0.
	AB(I,J,K)=0.
	AP(I,J,K)=1.
	BB(I,J,K)=0.
400	CONTINUE
	
C	*** EAST BOUNDARY IS OUTLET ***
C	*** Ux=V=W=Tx=0
	I=L2
	DO 410 J=2,M
	DO 410 K=2,N1
	AE(I,J,K)=0.
	AW(I,J,K)=0.
	AN(I,J,K)=0.
	AS(I,J,K)=0.
	AT(I,J,K)=0.
	AB(I,J,K)=0.
	AP(I,J,K)=1.
	BB(I,J,K)=0.
410	CONTINUE
!
C	*** SOUTH BOUNDARY IS WALL ***
C	*** Uy=V=Wy=0, Ty=0
	J=1
	DO 420 I=2,L1
	DO 420 K=2,N1
	AE(I,J,K)=0.
	AW(I,J,K)=0.
	AN(I,J,K)=0.
	AS(I,J,K)=0.
	AT(I,J,K)=0.
	AB(I,J,K)=0.
	AP(I,J,K)=1.
	BB(I,J,K)=0.
!
420	CONTINUE

C	*** NORTH BOUNDARY IS WALL ***
C	*** U=V=W=0, T=WALL
	J=M1
	DO 430 I=2,L1
	DO 430 K=2,N1
	AE(I,J,K)=0.
	AW(I,J,K)=0.
	AN(I,J,K)=0.
	AS(I,J,K)=0.
	AT(I,J,K)=0.
	AB(I,J,K)=0.
	AP(I,J,K)=1.
	BB(I,J,K)=0.
430	CONTINUE
!
C	*** BOTTOM BOUNDARY IS PLANE OF SYMMETRY ***
C	*** Uz=Vz=W=Tz=0
	K=1
	DO 440 I=2,L1
	DO 440 J=2,M
	AE(I,J,K)=0.
	AW(I,J,K)=0.
	AN(I,J,K)=0.
	AS(I,J,K)=0.
	AT(I,J,K)=1.
	AB(I,J,K)=0.
	AP(I,J,K)=1.
	BB(I,J,K)=0.
440	CONTINUE
	
C	*** TOP BOUNDARY IS WALL ***
C	*** U=V=W=0, T=TWALL
	K=N2
	DO 450 I=2,L1
	DO 450 J=2,M
	AE(I,J,K)=0.
	AW(I,J,K)=0.
	AN(I,J,K)=0.
	AS(I,J,K)=0.
	AT(I,J,K)=0.
	AB(I,J,K)=0.
	AP(I,J,K)=1.
	BB(I,J,K)=0.
450	CONTINUE
!
C       ***SAVE AP FOR PRESSURE SUBROUTINE***
        DO 500 K=1, N2
        DO 500 J=1, M1
	  DO 500 I=1, L2
        APV(I,J,K)=AP(I,J,K)	!-AE(I,J,K)-AW(I,J,K)-AN(I,J,K)-AS(I,J,K)-
!     6	AT(I,J,K)-AB(I,J,K)
500     CONTINUE
!
!	  DO 505 K=1, N2
!	  DO 505 I=1, L2
!       APV(I,M1,K)=AP(I,M1,K)
!505     CONTINUE
!
!	******** RELAXATION *****
	DO 510 K=1, N2
	DO 510 J=1, M1
	DO 510 I=1, L2
	AP(I,J,K)=AP(I,J,K)/ALPHAVEL
	BB(I,J,K)=BB(I,J,K)+(1.-ALPHAVEL)*AP(I,J,K)*VSTAR(I,J,K)
510	CONTINUE
!
C       ***CALCULATE VVEL***
		LEND=L1+1
		MEND=M1
		NEND=N1+1
			DO 550 K=1, NEND
		DO 550 J=1, MEND
	DO 550 I=1, LEND
				PHI(I,J,K)=VSTAR(I,J,K)
550			CONTINUE
!
	VAR='V'
	CALL TDMA3D
!
	WRITE(92,9200) IT,IS,ITER,RP0,RPK,RPR,GAMMAP
9200	FORMAT (3(I6),4(E15.4))
!
!		L1=L1-1
!		N1=N1-1
C	***ASSIGN NEW VALUES TO VNEW; AFTER CALLING WVEL***
C	***IT WILL BE ASSIGNED TO VSTGR***
        DO 600 K=1, N2
        DO 600 J=1, M1
	  DO 600 I=1, L2
        VNEW(I,J,K)=PHI(I,J,K)
600     CONTINUE
!        
		RETURN
	END
C	****************************************************************

